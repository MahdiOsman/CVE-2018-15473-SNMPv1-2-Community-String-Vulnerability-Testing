# Author: Mahdi Osman
# Description: Testing for CVE-2018-15473 and SNMPv1/v2c weak community strings
# Usage: docker build -t ssh-snmp .
#        docker run -d -p 2222:22 -p 161:161/udp ssh-snmp

# Use a base image with the desired operating system
# This example uses Ubuntu 18.04 as it comes with OpenSSH 7.6p1 (Vulnerable)
FROM ubuntu:18.04

# Install OpenSSH server and SNMP daemon (also add any needed dependencies and some useful tools for debugging)
RUN apt-get update && \
    apt-get install -y openssh-server snmpd=5.7.3+dfsg-1.8ubuntu3 libsnmp30=5.7.3+dfsg-1.8ubuntu3 iptables net-tools

# Set up OpenSSH configuration
RUN mkdir /var/run/sshd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Copy the startup script into the container
COPY start_services.sh /start_services.sh

# Set up root password
RUN echo 'root:newpassword' | chpasswd

# Intentionally using SNMPv1/v2c with weak community strings
RUN sed -i 's/^agentAddress .*$/agentAddress udp:161/' /etc/snmp/snmpd.conf
RUN echo 'rocommunity public' >> /etc/snmp/snmpd.conf
RUN echo 'rwcommunity public' >> /etc/snmp/snmpd.conf 

# Expose SSH and SNMP ports 
EXPOSE 22 161/udp

# Start SSH and SNMP using the script
CMD ["/start_services.sh"]
